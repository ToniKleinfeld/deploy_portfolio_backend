# Rate limiting zones (aggressiver)
limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=web:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;
limit_conn addr 5;

# Block malicious patterns from your logs
map $http_user_agent $bad_bot {
    default 0;
    ~*GenomeCrawlerd 1;
    ~*zgrab 1;
    ~*libredtail 1;
    ~*"Hello from Palo Alto" 1;
}

# Block malicious IPs from your logs
geo $bad_ip {
    default 0;
    104.234.115.131 1;  # GenomeCrawler
    50.117.21.19 1;     # PHPUnit exploits
    91.224.92.17 1;     # Persistent scanner
}

server {
    # Block bad bots and IPs
    if ($bad_bot) { return 444; }
    if ($bad_ip) { return 444; }
    
    # Enhanced blocking
    location ~ \.(env|git|sql|bak|config|ini|log|backup)$ {
        deny all;
        return 444;
    }
    
    location ~* /(wp-|admin|phpmyadmin|phpunit|vendor|cgi-bin|manager|hudson) {
        deny all;
        return 444;
    }
    
    # Block binary/malformed requests
    location ~* (\\x[0-9a-f]{2}|Gh0st|\x16\x03) {
        deny all;
        return 444;
    }
    
    # Rate limiting
    location / {
        limit_req zone=web burst=20 nodelay;
        limit_conn addr 5;
    }
}